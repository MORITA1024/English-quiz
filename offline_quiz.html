<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>単語ドリル（週まとめQR対応）</title>
<style>
  body{font-family:system-ui,-apple-system,"Segoe UI",Roboto;margin:16px}
  .wrap{max-width:720px;margin:0 auto}
  h1{font-size:20px;margin:8px 0 16px}
  label{display:block;margin:10px 0 6px}
  input,select,button{font-size:16px;padding:10px;width:100%;box-sizing:border-box}
  .btn{background:#0d6efd;color:#fff;border:none;border-radius:10px;margin-top:12px}
  .q{border:1px solid #ddd;border-radius:10px;padding:12px;margin:12px 0}
  .choice{display:block;border:1px solid #eee;border-radius:8px;padding:8px;margin:8px 0}
  .meta{color:#555;font-size:14px}
  .card{border:1px solid #ddd;border-radius:10px;padding:12px;margin:12px 0}
  .ok{color:#0a7a2f}.ng{color:#c1121f}
  #qr{margin-top:12px;text-align:center}
  canvas{margin-top:10px}
</style>

<div class="wrap">
  <h1>単語ドリル</h1>
  <p class="meta" id="status">問題を読み込んでいます…</p>

  <!-- トップ画面 -->
  <section id="start" hidden>
    <label>生徒番号（3桁）</label>
    <input id="sid" maxlength="3" placeholder="001" inputmode="numeric">
    <label>Day</label>
    <select id="day"></select>
    <button class="btn" id="go">テスト開始</button>

    <hr>
    <button class="btn" id="weekQR">週まとめQRを表示</button>
    <div id="qr" hidden>
      <h3>週まとめQRコード</h3>
      <canvas id="weekCanvas"></canvas>
      <p class="meta" id="qrInfo"></p>
      <button class="btn" id="closeQR">閉じる</button>
    </div>
  </section>

  <!-- テスト画面 -->
  <section id="quiz" hidden>
    <div class="meta">ID: <b id="vSid"></b> / Day <b id="vDay"></b></div>
    <div id="qs"></div>
    <button class="btn" id="submit">採点</button>
  </section>

  <!-- 結果画面 -->
  <section id="result" hidden>
    <div class="card"><b>スコア：<span id="score"></span></b></div>
    <h3>提出コード（確認用）</h3>
    <div class="card">
      <div class="code" id="code">（採点後に表示）</div>
      <button class="btn" id="again">もう一度解く</button>
      <button class="btn" id="back">最初に戻る</button>
    </div>
    <details>
      <summary>間違えた問題（復習）</summary>
      <div id="wrongs"></div>
    </details>
  </section>
</div>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.0/build/qrcode.min.js"></script>
<script>
const QUESTIONS_URL = "https://morita1024.github.io/English-quiz/questions.json";
const CACHE_KEY = "QUESTIONS_CACHE_V1";
const el = id => document.getElementById(id);
let QUESTIONS = null;

// ===== 問題を読み込み（キャッシュ対応） =====
async function loadQuestions() {
  el("status").textContent = "最新の問題を取得しています…";
  try {
    const r = await fetch(QUESTIONS_URL, { cache: "no-store" });
    if (!r.ok) throw new Error("HTTP " + r.status);
    const data = await r.json();
    QUESTIONS = data;
    localStorage.setItem(CACHE_KEY, JSON.stringify({ ts: Date.now(), data }));
    el("status").textContent = "最新の問題を読み込みました。";
  } catch (e) {
    const cached = localStorage.getItem(CACHE_KEY);
    if (cached) {
      const { data } = JSON.parse(cached);
      QUESTIONS = data;
      el("status").textContent = "オフラインモード（前回の問題を使用）";
    } else {
      el("status").textContent = "問題を取得できません。ネット接続を確認してください。";
      return false;
    }
  }
  return true;
}

// ===== Day選択リストを作成 =====
function refreshDays() {
  const sel = el("day");
  sel.innerHTML =
    '<option value="">選択</option>' +
    Object.keys(QUESTIONS)
      .map(k => `<option value="${k}">${k}</option>`)
      .join("");
}

// ===== 週データを収集して配列で返す =====
function collectWeeklyResults(id) {
  const results = [];
  for (let i = 1; i <= 7; i++) {
    const key = `vocab_day${i}_id${id}`;
    const data = localStorage.getItem(key);
    if (data) {
      const obj = JSON.parse(data);
      results.push({ day: i, score: obj.score, wrongMask: obj.wrongMask });
    }
  }
  if (!results.length) return null;
  const today = new Date();
  const date = today.toISOString().slice(0, 10); // YYYY-MM-DD
  const week = Math.ceil(results[0].day / 7) || 1;
  return { id, week, date, results };
}
// ===== 初期化 =====
async function init() {
  const ok = await loadQuestions();
  if (!ok) return;
  refreshDays();
  el("start").hidden = false;
}
init();

// ===== テスト開始 =====
el("go").onclick = () => {
  const sid = el("sid").value.trim().padStart(3, "0");
  const dayKey = el("day").value;
  if (!/^\d{3}$/.test(sid)) return alert("生徒番号は3桁で入力してください（例: 001）");
  if (!dayKey) return alert("Dayを選択してください。");

  const qs = QUESTIONS[dayKey];
  if (!qs || !qs.length) return alert("問題が見つかりません。");

  el("vSid").textContent = sid;
  el("vDay").textContent = dayKey.replace("Day", "");
  const box = el("qs");
  box.innerHTML = "";
  for (const q of qs) {
    const div = document.createElement("div");
    div.className = "q";
    div.innerHTML =
      `<div><b>Q${q.id}.</b> ${q.question}</div>` +
      q.choices
        .map(
          (c, i) =>
            `<label class="choice"><input type="radio" name="q${q.id}" value="${i}"> ${i + 1}. ${c}</label>`
        )
        .join("");
    box.appendChild(div);
  }
  el("start").hidden = true;
  el("quiz").hidden = false;
  el("result").hidden = true;
};

// ===== 採点処理 =====
el("submit").onclick = () => {
  const day = Number(el("vDay").textContent);
  const sid3 = el("vSid").textContent;
  const qs = QUESTIONS["Day" + day];
  let score = 0,
    wrongMask = 0,
    wrongItems = [];
  for (const q of qs) {
    const chosen = document.querySelector(`input[name="q${q.id}"]:checked`);
    const val = chosen ? Number(chosen.value) : null;
    if (val === q.answer) score++;
    else {
      wrongMask |= 1 << (q.id - 1);
      wrongItems.push({
        id: q.id,
        question: q.question,
        correct: q.choices[q.answer],
        chosen: val != null ? q.choices[val] : "未選択",
      });
    }
  }
  // 保存
  localStorage.setItem(
    `vocab_day${day}_id${sid3}`,
    JSON.stringify({
      id: sid3,
      day,
      score,
      wrongMask,
      timestamp: new Date().toISOString().slice(0, 10),
    })
  );

  // 表示
  el("score").textContent = `${score} / ${qs.length}`;
  el("code").textContent = `ID${sid3}-Day${day}-Score${score}`;
  el("wrongs").innerHTML =
    wrongItems
      .map(
        (w) =>
          `<div class="q"><div><b>Q${w.id}.</b> ${w.question}</div>` +
          `<div class="ng">正答：${w.correct}</div>` +
          `<div>あなた：${w.chosen}</div></div>`
      )
      .join("") || "<div class='ok'>全問正解！</div>";

  el("quiz").hidden = true;
  el("result").hidden = false;
};

// ===== 再挑戦・戻る =====
el("again").onclick = () => {
  el("result").hidden = true;
  el("quiz").hidden = false;
};
el("back").onclick = () => {
  el("result").hidden = true;
  el("quiz").hidden = true;
  el("start").hidden = false;
};

// ===== 週まとめQR生成 =====
el("weekQR").onclick = () => {
  const sid = el("sid").value.trim().padStart(3, "0");
  if (!/^\d{3}$/.test(sid)) return alert("生徒番号を入力してください。");
  const data = collectWeeklyResults(sid);
  if (!data) return alert("今週の結果が見つかりません。");

  // エンコード：簡易Base32＋CRC8
  const json = JSON.stringify(data);
  const bytes = new TextEncoder().encode(json);
  let crc = 0;
  for (const b of bytes) {
    crc ^= b;
    for (let i = 0; i < 8; i++) crc = (crc & 0x80) ? ((crc << 1) ^ 0x07) & 255 : (crc << 1) & 255;
  }
  const payload = btoa(json).replace(/=/g, "");
  const weekCode = payload + "-" + crc.toString(16).padStart(2, "0");

  // QR表示
  const canvas = el("weekCanvas");
  canvas.width = canvas.height = 256;
  QRCode.toCanvas(canvas, weekCode, { width: 256 }, (err) => {
    if (err) console.error(err);
  });
  el("qrInfo").textContent = `Week${data.week} / ${data.date} / ID${data.id}`;
  el("qr").hidden = false;
};
el("closeQR").onclick = () => (el("qr").hidden = true);
</script>
